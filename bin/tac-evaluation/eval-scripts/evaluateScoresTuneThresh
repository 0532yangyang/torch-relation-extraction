#!/bin/bash

SCORE_SCRIPT=$1
prediction=$2
exampleDir=$3
CONFIG=$4
PP=$5
KEY=$6
OUT=$7
THRESHOLDS="0.0 0.1 0.2 0.25 0.3 0.35 0.4 0.45 0.5 0.55 0.6 0.65 0.7 0.75 0.8 0.9 1.0"
#THRESHOLDS="0.0 0.1" # 0.2 0.25 0.3 0.35 0.4 0.45 0.5 0.55 0.6 0.65 0.7 0.75 0.8 0.9 1.0"

export TAC_ROOT=/iesl/canvas/belanger/relationfactory
TMP_DIR=`mktemp -d`/out/run2013
mkdir -p $TMP_DIR
PRED_ROOT=$TMP_DIR/prediction_
cd $TMP_DIR/../..
echo working in $PWD

for t in $THRESHOLDS; do
  # get thresholded patterns
  TMP_PREDICTION=${PRED_ROOT}$t
  echo "GETTING TOP $t"
  awk -v threshold=$t -F '\t' '{if($9 >= threshold) print  }' $prediction > $TMP_PREDICTION

  echo computing performance for $TMP_PREDICTION
  echo example dir = $exampleDir
  for fn in query.xml query_expanded.xml
  do
    cp $exampleDir/$fn $TMP_DIR/$fn
  done

  cp $TMP_PREDICTION $TMP_DIR/predictions_classifier_david
  rm -f $TMP_DIR/makefile $TMP_DIR/log4j.txt

  source /iesl/canvas/belanger/relationfactory/myEvaluation/setupPaths  $PWD/out/

  # convert scored candidates to response and calculate f1 score
  echo ISOLATED PERFORMANCE | tee $outReport
  TAC_SCRIPTS=${TH_RELEX_ROOT}/bin/tac-evaluation/eval-scripts

  $TAC_ROOT/bin/run.sh ${TAC_SCRIPTS}/$CONFIG

  echo -e "`$SCORE_SCRIPT $TMP_DIR/response_classifier_david_$PP $KEY | grep -e F1 -e Recall -e Precision | tr '\n' '\t' | sed 's/^\t*//'`\tThreshold: $t"
  cp  $TMP_DIR/response_classifier_david_$PP $TMP_PREDICTION
done

echo "Tuning per Relation and exporting best params to $OUT"
${TAC_SCRIPTS}/tunej.sh $KEY $SCORE_SCRIPT $PRED_ROOT $OUT $THRESHOLDS
rm -rf $TMP_DIR 
